<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Sona Music Analyzer - 시작 가이드</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; max-width: 800px; margin: auto; padding: 20px; line-height: 1.7; color: #333; }
        h1, h2, h3 { color: #111; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .section { background-color: #f9f9f9; padding: 25px; border-radius: 8px; border: 1px solid #eee; margin-top: 30px; }
        .warning { color: #d9534f; font-weight: bold; border: 1px solid #d9534f; padding: 10px; border-radius: 5px; margin: 15px 0; }
        code { background-color: #eef; color: #333; padding: 4px 7px; border-radius: 4px; font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace; font-size: 0.9em;}
        .download-btn { display: inline-block; background-color: #007bff; color: white; padding: 12px 18px; text-decoration: none; border-radius: 5px; font-weight: bold; margin-top: 15px; transition: background-color 0.2s; }
        .download-btn:hover { background-color: #0056b3; }
        hr { margin: 50px 0; border: 0; border-top: 1px solid #ddd; }
        #progress-container { display: none; margin-top: 20px; }
        progress { width: 100%; height: 25px; }
        #status { font-size: 1.1em; text-align: center; }
        ol li { margin-bottom: 10px; }
    </style>
</head>
<body>
    <header style="text-align: center; margin-bottom: 40px;">
        <h1>🎵 Sona Music Analyzer 시작 가이드</h1>
        <p>음악의 특징(템포, 에너지, 분위기 등)을 추출하는 분석 도구입니다.</p>
    </header>

    <div class="section">
        <h2>1. 시작하기 전에: 필수 프로그램 설치</h2>
        <p>이 분석 도구를 사용하려면, 아래 프로그램들이 컴퓨터에 먼저 설치되어 있어야 합니다. (최초 한 번만 설치)</p>
        <ol>
            <li><strong>Python (버전 3.10 권장):</strong> <a href="https://www.python.org/downloads/release/python-31011/" target="_blank">여기</a>에서 'Windows installer (64-bit)'를 다운로드하여 설치하세요. <br><strong>(중요!)</strong> 설치 첫 화면에서 <strong>'Add Python 3.10 to PATH' 체크박스를 반드시 선택</strong>해야 합니다.</li>
            <li><strong>FFmpeg:</strong> MP3 등 다양한 오디오 파일을 해석하기 위한 필수 번역기입니다. <a href="https://www.gyan.dev/ffmpeg/builds/" target="_blank">여기</a>에서 'ffmpeg-git-full.7z'를 다운로드하고 압축을 풀어 C드라이브에 옮긴 뒤, 환경 변수 PATH에 <code>C:\ffmpeg\bin</code>을 추가해주세요.</li>
        </ol>
        <p>위 프로그램들이 모두 설치되었다면 다음 단계로 진행하세요.</p>
    </div>

    <div class="section">
        <h2>2. 프로젝트 파일 준비</h2>
        <p>분석에 필요한 모든 스크립트 파일들을 아래 버튼을 눌러 한 번에 다운로드하세요.</p>
        <a href="/download_project_files" class="download-btn" download>프로젝트 파일 전체 다운로드 (.zip)</a>
        <p style="margin-top: 15px;">다운로드한 ZIP 파일의 압축을 풀면 아래 파일들이 포함되어 있습니다:</p>
        <ul>
            <li><code>app.py</code> (웹 서버 실행 파일)</li>
            <li><code>analyze_track.py</code> (대량 분석용 스크립트)</li>
            <li><code>templates/index.html</code> (현재 보고 계신 이 안내 페이지)</li>
            <li><code>requirements.txt</code> (필요한 파이썬 라이브러리 목록)</li>
        </ul>
    </div>

    <div class="section">
        <h2>3. 분석 도구 실행</h2>
        <p>압축을 푼 프로젝트 폴더에서 터미널(PowerShell)을 열고, 아래 순서대로 진행하세요.</p>
        <ol>
            <li>
                아래 명령어를 입력하여 분석에 필요한 모든 파이썬 라이브러리를 한 번에 설치합니다. (최초 한 번만 실행)
                <p><code>py -m pip install -r requirements.txt</code></p>
            </li>
            <li>
                이제 원하는 분석 방식을 선택하여 실행할 수 있습니다.
            </li>
        </ol>

        <h3 style="margin-top: 30px;">옵션 A: 웹 분석기 실행 (소량 파일용)</h3>
        <p>터미널에 아래 명령어를 입력하여 로컬 웹 서버를 켭니다.</p>
        <p><code>py app.py</code></p>
        <p>서버가 켜지면, 웹 브라우저 주소창에 <strong><code>http://127.0.0.1:5000</code></strong>을 입력하여 접속하세요. 아래에 보이는 웹 분석기를 통해 파일을 업로드하고 분석할 수 있습니다.</p>
        
        <h3 style="margin-top: 30px;">옵션 B: 대량 분석 스크립트 실행 (20곡 이상)</h3>
        <p>분석할 음악 파일들을 프로젝트 폴더 안의 <code>songs</code> 폴더(없으면 생성)에 넣은 뒤, 터미널에 아래 명령어를 입력하여 실행합니다.</p>
        <p><code>py analyze_track.py songs</code></p>
        <p>분석이 완료되면 <code>analysis_out</code> 폴더에 결과가 저장됩니다.</p>
    </div>

    <hr>

    <div class="section">
        <h2 style="text-align: center;">🌐 웹 분석기</h2>
        <form id="upload-form">
            <input type="file" id="audio-file-input" name="audio_files" accept=".mp3" multiple>
            <button type="submit" id="submit-btn">분석 시작 및 CSV 다운로드</button>
        </form>
        <div id="progress-container">
            <p id="status">분석 준비 중...</p>
            <progress id="progress-bar" value="0" max="100"></progress>
            <p><strong>분석 중에는 절대로 이 창을 닫거나 새로고침하지 마세요!</strong></p>
        </div>
    </div>

    <script>
        // (JavaScript 코드는 이전 버전과 동일)
        const form = document.getElementById('upload-form');
        const fileInput = document.getElementById('audio-file-input');
        const submitBtn = document.getElementById('submit-btn');
        const statusDiv = document.getElementById('status');
        const progressBar = document.getElementById('progress-bar');
        const progressContainer = document.getElementById('progress-container');

        let progressInterval;

        form.addEventListener('submit', async (event) => {
            event.preventDefault();

            if (fileInput.files.length === 0) { alert('오류: 분석할 파일을 선택해주세요.'); return; }
            if (fileInput.files.length > 100) { alert('오류: 최대 100개의 파일만 업로드할 수 있습니다.'); return; }
            
            submitBtn.disabled = true;
            progressContainer.style.display = 'block';
            statusDiv.textContent = '분석 서버에 작업 등록 중...';
            progressBar.value = 0;

            try {
                // 1. 서버에 분석 시작을 알리고 고유한 작업 ID를 받음
                const startResponse = await fetch('/start_analysis', { method: 'POST' });
                if (!startResponse.ok) throw new Error('작업 ID를 생성하지 못했습니다.');
                const { job_id } = await startResponse.json();

                // 2. 2초마다 진행 상황을 물어보기 시작
                progressInterval = setInterval(async () => {
                    try {
                        const statusResponse = await fetch(`/analysis_status/${job_id}`);
                        if (statusResponse.ok) {
                            const progress = await statusResponse.json();
                            progressBar.value = progress.total > 0 ? (progress.current / progress.total) * 100 : 0;
                            statusDiv.textContent = progress.status;
                        } else {
                            // 작업이 끝나면 서버가 404를 반환하므로, 여기서 인터벌을 멈추지 않음.
                        }
                    } catch (e) {
                        // Polling 중 에러 발생 시 인터벌 중지
                        clearInterval(progressInterval);
                    }
                }, 2000);

                // 3. 실제 파일들을 업로드하여 분석 시작
                const formData = new FormData();
                for (const file of fileInput.files) {
                    formData.append('audio_files', file);
                }
                const analyzeResponse = await fetch(`/analyze_batch/${job_id}`, {
                    method: 'POST',
                    body: formData,
                });

                // 4. 분석이 모두 끝나면 진행 상황 업데이트 중지
                clearInterval(progressInterval);

                if (analyzeResponse.ok) {
                    progressBar.value = 100;
                    statusDiv.textContent = "✅ 분석 완료! 파일 다운로드를 시작합니다...";
                    
                    const blob = await analyzeResponse.blob();
                    const contentDisposition = analyzeResponse.headers.get('content-disposition');
                    let filename = "analysis_summary.csv";
                    if (contentDisposition) {
                        const filenameMatch = contentDisposition.match(/filename="(.+)"/);
                        if (filenameMatch && filenameMatch.length > 1) filename = filenameMatch[1];
                    }
                    const downloadUrl = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = downloadUrl;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    window.URL.revokeObjectURL(downloadUrl);
                    statusDiv.innerHTML += `<br><strong>'${filename}'</strong> 파일이 다운로드되었습니다.`;
                } else {
                    const errorText = await analyzeResponse.text();
                    statusDiv.textContent = '서버 오류: ' + errorText;
                }

            } catch (error) {
                statusDiv.textContent = '네트워크 또는 분석 중 심각한 오류가 발생했습니다: ' + error;
                clearInterval(progressInterval);
            } finally {
                submitBtn.disabled = false;
            }
        });
    </script>
</body>
</html>