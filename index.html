<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>AI ìŒì•… ë¶„ì„ê¸° (ì •í™•ë„ ê°•í™”Â·ì˜¨ë¼ì¸ ë°°í¬ìš©)</title>

  <!-- âœ… Essentia Î²6: npm CDN (ë¸Œë¼ìš°ì € ì „ì—­ ë°”ì¸ë”© ë³´ì¥) -->
  <script src="https://cdn.jsdelivr.net/npm/essentia.js@0.1.0-beta6/dist/essentia-wasm.web.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/essentia.js@0.1.0-beta6/dist/essentia.js"></script>

  <!-- âœ… Meyda (íŠ¹ì§• ì¶”ì¶œ) -->
  <script src="https://cdn.jsdelivr.net/npm/meyda@5.6.3/dist/web/meyda.min.js"></script>

  <style>
    :root{ --accent:#37e0c3; --bg:#1a1d21; --card:#20252b; --fg:#e9f0f5; --muted:#98a7b5; --danger:#ff6b6b }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Apple SD Gothic Neo,Malgun Gothic,sans-serif}
    .wrap{max-width:1000px;margin:42px auto;padding:0 18px}
    .card{background:var(--card);border:1px solid #2a323a;border-radius:14px;padding:18px}
    h1{margin:0 0 8px;font-size:26px}
    p{margin:6px 0;color:var(--muted)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{background:var(--accent);color:#042a25;border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn.secondary{background:#2b343d;color:var(--fg);border:1px solid #3a4551}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .pill{padding:6px 10px;border:1px solid #2f3a45;border-radius:999px;color:#b9c7d3;font-size:12px}
    audio{width:100%}
    pre{background:#0f1317;border:1px solid #27323c;border-radius:10px;padding:10px;max-height:420px;overflow:auto}
    .grid{display:grid;gap:18px}
    .bpmBox{border:1px solid #2f3a45;border-radius:12px;padding:12px;max-width:320px}
    .warn{color:#ffb4b4;font-weight:700;min-height:1.2em}
    .hint{color:#8fa2b3;font-size:12px}
    .bar{width:100%;height:18px;background:#2b343d;border-radius:6px;overflow:hidden}
    .bar>span{display:block;height:100%;background:var(--accent);width:0}
    .right{display:flex;justify-content:flex-end}
  </style>
</head>
<body>
  <div class="wrap grid">
    <div class="card">
      <h1>ğŸµ AI ìŒì•… ë ˆì‹œí”¼ ì¶”ì¶œê¸°</h1>
      <p>ì˜¨ë¼ì¸ì—ì„œ íŒŒì¼ ì—…ë¡œë“œë§Œìœ¼ë¡œ <b>BPM(ì •í™•ë„ ê°•í™”)</b> + <b>Meyda íŠ¹ì§•</b>ì„ ì¶”ì¶œí•˜ê³ , <b>ê²½ëŸ‰ JSON</b>ìœ¼ë¡œ ì €ì¥í•©ë‹ˆë‹¤.</p>
      <div class="row" style="margin-top:6px">
        <input type="file" id="fileInput" accept="audio/*">
        <button id="analyzeBtn" class="btn" disabled>ë¶„ì„ ì‹œì‘</button>
        <button id="saveBtn" class="btn secondary" style="display:none">JSON ì €ì¥ ğŸ’¾</button>
      </div>
      <div class="row" style="margin-top:10px">
        <span class="pill">Serve: <span id="serveInfo"></span></span>
        <span class="pill">Essentia: <span id="essState">loadingâ€¦</span></span>
        <span class="pill">Method: <span id="method">â€”</span></span>
        <span class="pill">ìœˆë„ìš°: 15s / stride 5s</span>
      </div>
    </div>

    <div class="card grid">
      <audio id="audio" controls preload="metadata"></audio>
      <div class="bpmBox">
        <b>BPM ë¶„ì„ ê²°ê³¼</b>
        <div style="margin-top:6px">BPM: <span id="bpm">â€”</span></div>
        <div>ì‹ ë¢°ë„: <span id="conf">â€”</span></div>
        <div>ë©”ì‹œì§€: <span id="msg" class="warn"></span></div>
      </div>
      <div>
        <div class="bar"><span id="progress"></span></div>
        <div class="hint">Meyda í”„ë ˆì„ ìˆ˜ì§‘ ì§„í–‰ë¥ </div>
      </div>
    </div>

    <div class="card grid">
      <h3 style="margin:0">Meyda.js ìƒì„¸ ë°ì´í„° (ê²½ëŸ‰í™” ì ìš©)</h3>
      <pre id="out">ë¶„ì„ ëŒ€ê¸° ì¤‘...</pre>
      <div class="hint">ì €ì¥ ì‹œ í™”ë©´ìš© ë“¤ì—¬ì“°ê¸°ëŠ” ì œê±°ë˜ê³ , ê³µë°± ì—†ëŠ” JSONìœ¼ë¡œ ë‚´ë ¤ë°›ìŠµë‹ˆë‹¤.</div>
    </div>
  </div>

  <script>
    /***************** ì˜µì…˜ (ì •í™•ë„Â·ìš©ëŸ‰ ë°¸ëŸ°ìŠ¤) *****************/
    const MAX_SECONDS     = 60;     // ë¶„ì„ ìµœëŒ€ êµ¬ê°„(ì´ˆ)
    const WIN_SECONDS     = 15;     // BPM ì¶”ì • ìœˆë„ìš° ê¸¸ì´
    const STRIDE_SECONDS  = 5;      // ìœˆë„ìš° ì´ë™ ê°„ê²©
    const PURE_SR         = 11025;  // Pure-JS ë‹¤ìš´ìƒ˜í”Œ SR
    const FRAME_STRIDE    = 3;      // Meyda ní”„ë ˆì„ ì¤‘ 1í”„ë ˆì„ë§Œ ê¸°ë¡
    const DECIMALS        = 4;      // ìˆ«ì ì†Œìˆ˜ì 
    const MFCC_KEEP       = 13;     // MFCC ì°¨ì› ì œí•œ
    const CHROMA_KEEP     = 12;     // í¬ë¡œë§ˆ ì°¨ì› ì œí•œ

    /***************** DOM *****************/
    const $ = id => document.getElementById(id);
    const serveInfo = $('serveInfo'); serveInfo.textContent = location.protocol + '//' + location.host;
    const essState  = $('essState');
    const methodEl  = $('method');
    const fileInput = $('fileInput');
    const analyzeBtn= $('analyzeBtn');
    const saveBtn   = $('saveBtn');
    const audio     = $('audio');
    const bpmEl     = $('bpm');
    const confEl    = $('conf');
    const msgEl     = $('msg');
    const outEl     = $('out');
    const progBar   = $('progress');

    /***************** Essentia ì´ˆê¸°í™” *****************/
    let essentia = null;
    const essentiaReady = (async ()=>{
      try{
        if (typeof window.EssentiaWASM !== 'function' || typeof window.Essentia !== 'function') {
          throw new Error('Essentia libs not found on window');
        }
        const Module = await window.EssentiaWASM();
        essentia = new window.Essentia(Module);
        essState.textContent = 'ready';
        return true;
      } catch (e) {
        console.warn('Essentia init error:', e);
        essState.textContent = 'error';
        return false;
      }
    })();

    /***************** ìœ í‹¸ *****************/
    const round = (x,k=DECIMALS)=> typeof x==='number' ? +x.toFixed(k) : x;
    const roundArr = (arr, keep=null)=> (keep?arr.slice(0,keep):arr).map(v=>round(v));
    function roundFeatures(f){
      const o={}; for(const k in f){
        const v=f[k];
        if(Array.isArray(v)){
          if(k==='mfcc') o[k]=roundArr(v, MFCC_KEEP);
          else if(k==='chroma') o[k]=roundArr(v, CHROMA_KEEP);
          else o[k]=roundArr(v);
        } else if (typeof v==='number'){ o[k]=round(v); }
        else o[k]=v;
      } return o;
    }
    function octaveCorrect(bpm){
      // 70~180 ê·¼ì²˜ë¡œ ì ‘ì–´ ë„£ê¸°
      while (bpm<70) bpm*=2;
      while (bpm>180) bpm/=2;
      return bpm;
    }
    function vectorize(data){
      if (essentia.audioBufferToVector) return essentia.audioBufferToVector(data);
      if (essentia.arrayToVector)      return essentia.arrayToVector(data);
      return essentia.vectorFloatToVector(Array.from(data));
    }

    /***************** BPM â€” Essentia ìœˆë„ìš° í•©ì˜ *****************/
    async function bpmUsingEssentia(file){
      const ok = await essentiaReady;
      if (!ok || !essentia) throw new Error('Essentia not ready');

      const ac  = new (window.AudioContext || window.webkitAudioContext)();
      const ab  = await ac.decodeAudioData(await file.arrayBuffer());
      const sr  = ab.sampleRate;
      const left= ab.getChannelData(0);

      const dur = Math.min(ab.duration, MAX_SECONDS);
      const win = Math.floor(WIN_SECONDS * sr);
      const hop = Math.floor(STRIDE_SECONDS * sr);
      const end = Math.floor(dur * sr);

      const bpms = [];
      for (let start=0; start+win<=end; start+=hop) {
        const seg = left.subarray(start, start+win);
        const v   = vectorize(seg);
        const r   = essentia.PercivalBpmEstimator(v);
        bpms.push(octaveCorrect(r.bpm));
      }
      ac.close();

      // ìœˆë„ìš° ì¤‘ì•™ê°’ + IQRë¡œ ì´ìƒì¹˜ ì–µì œ
      bpms.sort((a,b)=>a-b);
      const median = bpms.length ? bpms[Math.floor(bpms.length/2)] : NaN;

      // ì „ì²´ 60ì´ˆ í‰ê·  ì‹ ë¢°ë„ ê·¼ì‚¬ì¹˜: ë¶„ì‚° ê¸°ë°˜ìœ¼ë¡œ ëŒ€ëµí™”
      const mean = bpms.reduce((s,x)=>s+x,0)/bpms.length;
      const sd   = Math.sqrt(bpms.reduce((s,x)=>s+(x-mean)**2,0)/Math.max(1,bpms.length-1));
      const conf = Math.max(0, Math.min(1, 1 - (sd/mean))); // ë¶„ì‚°ì´ ì‘ì„ìˆ˜ë¡ confident

      return { bpm: round(median,1), confidence: round(conf,3), method:'essentia' };
    }

    /***************** BPM â€” PureJS(ìë™ìƒê´€), ë™ì¼ ìœˆë„ìš° ì „ëµ *****************/
    async function bpmUsingPureJS(file){
      // 60ì´ˆ/11.025kHzë¡œ ë¦¬ìƒ˜í”Œ â†’ ìœˆë„ìš°ë³„ ìë™ìƒê´€
      const raw  = await file.arrayBuffer();
      const tmp  = new (window.AudioContext || window.webkitAudioContext)();
      const buf  = await tmp.decodeAudioData(raw);
      const dur  = Math.min(buf.duration, MAX_SECONDS);

      const offline = new OfflineAudioContext(1, Math.floor(dur*PURE_SR), PURE_SR);
      const bs = offline.createBufferSource();
      bs.buffer = buf; bs.connect(offline.destination); bs.start(0,0,dur);
      const ab = await offline.startRendering();
      tmp.close();

      const data = ab.getChannelData(0);
      const sr   = PURE_SR;
      const win  = Math.floor(WIN_SECONDS * sr);
      const hop  = Math.floor(STRIDE_SECONDS * sr);
      const end  = data.length;

      const MIN_BPM=60, MAX_BPM=200;
      const lagMin = Math.round((60/MAX_BPM)*sr);
      const lagMax = Math.round((60/MIN_BPM)*sr);

      function acfBestLag(arr){ // ê°€ì¥ ë‹¨ìˆœí•˜ê³  ë¹ ë¥¸ ACF
        const N = arr.length;
        const diff = new Float32Array(N-1);
        for(let i=1;i<N;i++) diff[i-1]=arr[i]-arr[i-1];
        let bestLag=-1,best= -Infinity;
        for(let lag=lagMin;lag<=lagMax;lag++){
          let s=0; for(let i=0;i<diff.length-lag;i++) s+= diff[i]*diff[i+lag];
          if (s>best){best=s;bestLag=lag;}
        }
        return {lag:bestLag, score:best};
      }

      const bpms=[], scores=[];
      for(let st=0; st+win<=end; st+=hop){
        const seg = data.subarray(st, st+win);
        const {lag,score}=acfBestLag(seg);
        let bpm = 60*sr/lag;
        bpms.push(octaveCorrect(bpm));
        scores.push(score);
      }

      bpms.sort((a,b)=>a-b);
      const median = bpms.length ? bpms[Math.floor(bpms.length/2)] : NaN;

      const mean = bpms.reduce((s,x)=>s+x,0)/bpms.length;
      const sd   = Math.sqrt(bpms.reduce((s,x)=>s+(x-mean)**2,0)/Math.max(1,bpms.length-1));
      const conf = Math.max(0, Math.min(1, 1 - (sd/mean)));

      return { bpm: round(median,1), confidence: round(conf,3), method:'purejs' };
    }

    /***************** Meyda ìˆ˜ì§‘ (ê²½ëŸ‰í™”) *****************/
    let audioCtx, source, meyda;
    function ensureGraph(){
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        source   = audioCtx.createMediaElementSource(audio);
        source.connect(audioCtx.destination);
      }
    }

    /***************** íŒŒì¼ ì„ íƒ *****************/
    let currentFile=null, currentFileName='';
    fileInput.addEventListener('change', e=>{
      const f = e.target.files?.[0];
      if (!f) return;
      currentFile = f; currentFileName = f.name;
      ensureGraph();
      audio.src = URL.createObjectURL(f);
      analyzeBtn.disabled = false;
      bpmEl.textContent='â€”'; confEl.textContent='â€”'; msgEl.textContent='';
      methodEl.textContent='â€”';
      outEl.textContent='ë¶„ì„ ëŒ€ê¸° ì¤‘...';
      progBar.style.width='0%';
      saveBtn.style.display='none';
    });

    /***************** ë¶„ì„ ì‹œì‘ *****************/
    analyzeBtn.addEventListener('click', async ()=>{
      if (!currentFile) return;

      analyzeBtn.disabled = true;
      msgEl.textContent='';

      // 1) BPM (Essentia â†’ ì‹¤íŒ¨ ì‹œ PureJS)
      let res;
      try{
        res = await bpmUsingEssentia(currentFile);
      }catch(e){
        console.warn('Essentia BPM failed â†’ fallback:', e);
        res = await bpmUsingPureJS(currentFile);
      }
      bpmEl.textContent = res.bpm; confEl.textContent = res.confidence;
      methodEl.textContent = res.method;
      if (res.confidence < 0.5) msgEl.textContent = 'âš ï¸ BPM ì‹ ë¢°ë„ê°€ ë‚®ìŠµë‹ˆë‹¤. (ë¬´ë“œÂ·ë¼ì´ë¸ŒÂ·ë³€ì† íŠ¸ë™ ê°€ëŠ¥ì„±)';

      // 2) Meyda íŠ¹ì§• ì¶”ì¶œ (FRAME_STRIDEë¡œ ê²½ëŸ‰í™”)
      if (audioCtx.state==='suspended') await audioCtx.resume();
      const feats = ['mfcc','chroma','energy','spectralCentroid','perceptualSharpness','zcr','spectralRolloff'];
      const coll = {}; feats.forEach(k=>coll[k]=[]);
      outEl.textContent='Meyda ìˆ˜ì§‘ ì¤‘â€¦';

      audio.currentTime = 0;
      audio.play();

      let frames=0;
      const stopAt = () => Math.min(audio.duration || Infinity, MAX_SECONDS);
      meyda = Meyda.createMeydaAnalyzer({
        audioContext: audioCtx,
        source: source,
        bufferSize: 1024,
        featureExtractors: feats,
        callback: (f)=>{
          frames++;
          if (frames % FRAME_STRIDE !== 0) return;
          const r = roundFeatures(f);
          for(const k in r){ if(coll[k]) coll[k].push(r[k]); }
          // progress
          const cur = Math.min(audio.currentTime, stopAt());
          progBar.style.width = ((cur/stopAt())*100).toFixed(1)+'%';
          if (audio.currentTime >= stopAt()) {
            meyda.stop(); audio.pause(); finalize();
          }
        }
      });
      meyda.start();

      function finalize(){
        // í™”ë©´ìš© ë³´ê¸°
        outEl.textContent = JSON.stringify({features:coll}, null, 2);
        saveBtn.style.display='inline-block';
        analyzeBtn.disabled=false;
        // ì €ì¥ í•¸ë“¤ëŸ¬
        saveBtn.onclick = ()=>{
          const payload = { bpm: res, features: coll };
          const blob = new Blob([JSON.stringify(payload)], {type:'application/json'});
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = (currentFileName||'audio').replace(/\.[^/.]+$/,'') + '.json';
          document.body.appendChild(a); a.click(); a.remove();
        };
      }
    });

    /***************** ì¬ìƒ ë§‰ëŒ€ ë™ê¸°í™” *****************/
    audio.addEventListener('timeupdate', ()=>{
      if (!audio.duration) return;
      const stop = Math.min(audio.duration, MAX_SECONDS);
      const cur  = Math.min(audio.currentTime, stop);
      progBar.style.width = ((cur/stop)*100).toFixed(1)+'%';
    });
    audio.addEventListener('ended', ()=>{
      if (meyda) meyda.stop();
    });
  </script>
</body>
</html>
