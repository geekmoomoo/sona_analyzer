<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>AI ìŒì•… ë¶„ì„ê¸° (ì˜¨ë¼ì¸Â·ìš©ëŸ‰ ìµœì í™”)</title>

  <!-- âœ… Essentia Î²6 (ë¸Œë¼ìš°ì € ì „ì—­ ë°”ì¸ë”© ë³´ì¥) -->
  <script src="https://cdn.jsdelivr.net/gh/MTG/essentia.js@0.1.0-beta6/dist/essentia-wasm.web.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/MTG/essentia.js@0.1.0-beta6/dist/essentia.js"></script>

  <!-- âœ… Meyda CDN -->
  <script src="https://cdn.jsdelivr.net/npm/meyda@5.6.3/dist/web/meyda.min.js"></script>

  <style>
    body{font-family:sans-serif;background:#1e1e1e;color:#d4d4d4;display:flex;justify-content:center;align-items:center;min-height:100vh;margin:0;padding:1rem}
    .container{background:#252526;padding:2rem;border-radius:10px;border:1px solid #3c3c3c;width:92%;max-width:900px}
    h1,h3{color:#4ec9b0;text-align:center;margin:0 0 .6rem}
    p{text-align:center;color:#9cdcfe;margin:.2rem 0 .8rem}
    .controls{display:flex;flex-direction:column;align-items:center;gap:12px;margin:10px 0 18px}
    button{background:#4ec9b0;color:#1e1e1e;border:none;padding:10px 16px;border-radius:8px;font-size:15px;cursor:pointer}
    button:disabled{background:#3c3c3c;cursor:not-allowed}
    .progress-container{width:100%;background:#3c3c3c;border-radius:6px;margin-top:10px;display:none}
    progress{width:100%;height:18px;appearance:none}
    progress::-webkit-progress-bar{background:#3c3c3c;border-radius:6px}
    progress::-webkit-progress-value{background:#4ec9b0;border-radius:6px}
    pre{background:#1e1e1e;color:#dcdcaa;padding:12px;border-radius:8px;border:1px solid #3c3c3c;white-space:pre-wrap;word-wrap:break-word;max-height:420px;overflow:auto;margin-top:12px}
    .bpm-results{text-align:center;margin:12px 0;padding:12px;border:1px solid #3c3c3c;border-radius:8px}
    .bpm-warning{color:#e57373;font-weight:bold;min-height:1.2em}
    .row{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
    .pill{padding:6px 10px;border:1px solid #3c3c3c;border-radius:999px;color:#a6b2c0;font-size:12px}
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸµ AI ìŒì•… ë ˆì‹œí”¼ ì¶”ì¶œê¸°</h1>
    <p>íŒŒì¼ ì—…ë¡œë“œë§Œìœ¼ë¡œ ì˜¨ë¼ì¸ì—ì„œ BPM + Meyda íŠ¹ì§•ì„ ì¶”ì¶œí•˜ê³ , ìš©ëŸ‰ì„ ì¤„ì—¬ JSON ì €ì¥í•©ë‹ˆë‹¤.</p>

    <div class="controls">
      <input type="file" id="fileInput" accept="audio/*" />
      <audio id="audioPlayer" style="display:none;"></audio>
      <div class="row">
        <span class="pill">Serve: <span id="serveInfo"></span></span>
        <span class="pill">Essentia: <span id="essState">loadingâ€¦</span></span>
        <span class="pill">Method: <span id="method">â€”</span></span>
      </div>
      <button id="analyzeButton" disabled>íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”</button>
      <button id="saveButton" style="display:none;">JSON ë°ì´í„° ì €ì¥ ğŸ’¾</button>

      <div id="bpm-results" class="bpm-results" style="display:none;">
        <h3>BPM ë¶„ì„ ê²°ê³¼</h3>
        <p><strong>BPM:</strong> <span id="essentia-bpm">â€”</span></p>
        <p><strong>ì‹ ë¢°ë„:</strong> <span id="essentia-confidence">â€”</span></p>
        <p class="bpm-warning" id="bpm-warning"></p>
      </div>

      <div id="progressContainer" class="progress-container">
        <progress id="progressBar" value="0" max="100"></progress>
      </div>
    </div>

    <h3>Meyda.js ìƒì„¸ ë°ì´í„° (AI í•™ìŠµìš©, ê²½ëŸ‰í™” ì ìš©)</h3>
    <pre id="results">ë¶„ì„ ëŒ€ê¸° ì¤‘...</pre>
  </div>

  <script>
    /***** ì˜µì…˜: ìš©ëŸ‰ ìµœì í™” íŒŒë¼ë¯¸í„° *****/
    const MAX_SECONDS = 60;   // ìµœëŒ€ ë¶„ì„ ì‹œê°„(ì´ˆ)
    const FRAME_STRIDE = 3;   // ní”„ë ˆì„ë§ˆë‹¤ 1í”„ë ˆì„ë§Œ ì €ì¥
    const DECIMALS = 4;       // ì†Œìˆ˜ì  ìë¦¿ìˆ˜
    const MFCC_KEEP = 13;
    const CHROMA_KEEP = 12;

    const $ = (id)=>document.getElementById(id);
    $('serveInfo').textContent = location.protocol + '//' + location.host;

    const fileInput = $('fileInput');
    const audioPlayer = $('audioPlayer');
    const analyzeButton = $('analyzeButton');
    const saveButton = $('saveButton');
    const resultsDisplay = $('results');
    const progressContainer = $('progressContainer');
    const progressBar = $('progressBar');
    const bpmResultsDiv = $('bpm-results');
    const essentiaBpmSpan = $('essentia-bpm');
    const essentiaConfidenceSpan = $('essentia-confidence');
    const bpmWarningSpan = $('bpm-warning');
    const essState = $('essState');
    const methodEl = $('method');

    let audioContext, source, meydaAnalyzer;
    let featureCollection = {};
    let originalFileName = '';
    let bpmResult = null;

    /***** ìˆ«ì ì •ë°€ë„ ì¶•ì†Œ + ì°¨ì› ì¶•ì•½ *****/
    function roundNum(x, k=DECIMALS){ return typeof x==='number' ? parseFloat(x.toFixed(k)) : x; }
    function roundArray(arr, keep=null){ const a = keep ? arr.slice(0, keep) : arr; return a.map(v=>roundNum(v)); }
    function roundFeatures(features){
      const out = {};
      for (const k in features){
        const v = features[k];
        if (Array.isArray(v)){
          if (k==='mfcc') out[k] = roundArray(v, MFCC_KEEP);
          else if (k==='chroma') out[k] = roundArray(v, CHROMA_KEEP);
          else out[k] = roundArray(v);
        }else if (typeof v === 'number'){ out[k] = roundNum(v); }
        else{ out[k] = v; }
      }
      return out;
    }

    /***** Essentia ì´ˆê¸°í™” (Î²6) â€” â›” ì˜µì…”ë„ì²´ì´ë‹ ì œê±°, ì •í™•í•œ í´ë˜ìŠ¤ëª… ì‚¬ìš© *****/
    let essentia = null;
    const essentiaReady = (async ()=>{
      try{
        if (typeof window.EssentiaWASM !== 'function' || typeof window.Essentia !== 'function'){
          throw new Error('Essentia libs not found on window');
        }
        const Module = await window.EssentiaWASM();
        // âœ… ì—¬ê¸°! ë¬¸ë²•ì˜¤íƒ€/ì˜µì…”ë„ì²´ì´ë‹ ì œê±°
        essentia = new window.Essentia(Module);
        essState.textContent = 'ready';
        return true;
      }catch(e){
        console.warn('Essentia init error:', e);
        essState.textContent = 'error';
        return false;
      }
    })();

    /***** Pure-JS ìë™ìƒê´€ BPM (ë°±ì—…ìš©) *****/
    async function estimateBpmPureJS(file){
      const TEMP_SR = 11025, MIN_BPM = 60, MAX_BPM = 200;
      const buf = await file.arrayBuffer();
      const ac = new (window.AudioContext || window.webkitAudioContext)();
      const original = await ac.decodeAudioData(buf);
      const dur = Math.min(original.duration, MAX_SECONDS);
      const offline = new OfflineAudioContext(1, Math.floor(dur*TEMP_SR), TEMP_SR);
      const bs = offline.createBufferSource();
      bs.buffer = original; bs.connect(offline.destination); bs.start(0, 0, dur);
      const ab = await offline.startRendering(); ac.close();

      const data = ab.getChannelData(0);
      const N = data.length;
      const diff = new Float32Array(N-1);
      for (let i=1;i<N;i++) diff[i-1] = data[i]-data[i-1];

      const maxLag = Math.round((60/MIN_BPM)*TEMP_SR);
      const minLag = Math.round((60/MAX_BPM)*TEMP_SR);
      let bestLag=-1, bestVal=-Infinity;
      for (let lag=minLag; lag<=maxLag; lag++){
        let sum=0; for (let i=0;i<diff.length-lag;i++) sum += diff[i]*diff[i+lag];
        if (sum>bestVal){ bestVal=sum; bestLag=lag; }
      }
      if (bestLag<0) throw new Error('autocorr-failed');

      let bpm = 60*TEMP_SR/bestLag;
      while (bpm<70) bpm*=2;
      while (bpm>180) bpm/=2;

      return { bpm: roundNum(bpm,1), confidence: roundNum(bestVal/1e8,3), method:'purejs' };
    }

    /***** Essentia BPM *****/
    async function getBpmWithEssentia(file){
      const ok = await essentiaReady;
      if (!ok || !essentia) throw new Error('Essentia not ready');

      const ac = new (window.AudioContext || window.webkitAudioContext)();
      const arrayBuffer = await file.arrayBuffer();
      const audioBuffer = await ac.decodeAudioData(arrayBuffer);
      const data = audioBuffer.getChannelData(0);
      const v = (typeof essentia.audioBufferToVector==='function')
        ? essentia.audioBufferToVector(data)
        : (typeof essentia.arrayToVector==='function')
          ? essentia.arrayToVector(data)
          : essentia.vectorFloatToVector(Array.from(data));

      const r = essentia.PercivalBpmEstimator(v);
      let bpm = r.bpm, conf = r.confidence;
      if (bpm>180 && bpm/2>=70) bpm/=2; else if (bpm<70 && bpm*2<=180) bpm*=2;

      ac.close();
      return { bpm: roundNum(bpm,1), confidence: roundNum(conf,3), method:'essentia' };
    }

    /***** íŒŒì¼ ì„ íƒ *****/
    fileInput.addEventListener('change', (e)=>{
      const file = e.target.files?.[0];
      if (!file) return;
      if (!audioContext){
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        source = audioContext.createMediaElementSource(audioPlayer);
        source.connect(audioContext.destination);
      }
      audioPlayer.src = URL.createObjectURL(file);
      originalFileName = file.name;
      analyzeButton.disabled = false;
      analyzeButton.textContent = 'ë¶„ì„ ì‹œì‘';
      saveButton.style.display = 'none';
      bpmResultsDiv.style.display = 'none';
      $('method').textContent = 'â€”';
      resultsDisplay.textContent = 'ë¶„ì„ ëŒ€ê¸° ì¤‘...';
    });

    /***** ë¶„ì„ ì‹œì‘ *****/
    analyzeButton.addEventListener('click', async ()=>{
      const file = fileInput.files?.[0];
      if (!file) return;

      analyzeButton.disabled = true;
      analyzeButton.textContent = 'ë¶„ì„ ì¤‘...';
      progressContainer.style.display = 'block';
      progressBar.value = 0;
      bpmResultsDiv.style.display = 'block';
      essentiaBpmSpan.textContent = 'ê³„ì‚° ì¤‘...';
      essentiaConfidenceSpan.textContent = 'ê³„ì‚° ì¤‘...';
      bpmWarningSpan.textContent = '';
      methodEl.textContent = 'â€”';

      // 1) BPM (Essentia â†’ ì‹¤íŒ¨ ì‹œ PureJS)
      try{
        bpmResult = await getBpmWithEssentia(file);
      }catch(e){
        console.warn('Essentia BPM failed â†’ fallback:', e);
        bpmResult = await estimateBpmPureJS(file);
      }
      essentiaBpmSpan.textContent = bpmResult.bpm;
      essentiaConfidenceSpan.textContent = bpmResult.confidence;
      methodEl.textContent = bpmResult.method;
      if (bpmResult.confidence < 0.5) bpmWarningSpan.textContent = 'âš ï¸ BPM ì‹ ë¢°ë„ê°€ ë‚®ìŠµë‹ˆë‹¤.';

      // 2) Meyda ìˆ˜ì§‘ (í”„ë ˆì„ ìŠ¤í‚µ + ìµœëŒ€ 60ì´ˆ)
      if (audioContext.state === 'suspended') await audioContext.resume();

      const featureExtractors = ['mfcc','chroma','energy','spectralCentroid','perceptualSharpness','zcr','spectralRolloff'];
      featureCollection = {}; featureExtractors.forEach(k=>featureCollection[k]=[]);

      audioPlayer.currentTime = 0;
      audioPlayer.play();

      let frameCount = 0;
      const stopAt = () => Math.min(audioPlayer.duration || Infinity, MAX_SECONDS);

      meydaAnalyzer = Meyda.createMeydaAnalyzer({
        audioContext,
        source,
        bufferSize: 1024,
        featureExtractors,
        callback: (features)=>{
          frameCount++;
          if (frameCount % FRAME_STRIDE !== 0) return;

          const rounded = roundFeatures(features);
          for (const k in rounded){
            if (featureCollection[k]) featureCollection[k].push(rounded[k]);
          }

          if (audioPlayer.currentTime >= stopAt()){
            meydaAnalyzer.stop();
            audioPlayer.pause();
            finalize();
          }
        }
      });
      meydaAnalyzer.start();
    });

    function finalize(){
      resultsDisplay.textContent = JSON.stringify({features:featureCollection}, null, 2);
      analyzeButton.disabled = false;
      analyzeButton.textContent = 'ë‹¤ë¥¸ íŒŒì¼ ë¶„ì„í•˜ê¸°';
      saveButton.style.display = 'inline-block';
      progressContainer.style.display = 'none';
    }

    audioPlayer.addEventListener('timeupdate', ()=>{
      if (audioPlayer.duration){
        const stopAt = Math.min(audioPlayer.duration, MAX_SECONDS);
        const cur = Math.min(audioPlayer.currentTime, stopAt);
        progressBar.value = (cur / stopAt) * 100;
      }
    });
    audioPlayer.addEventListener('ended', ()=>{
      if (meydaAnalyzer) meydaAnalyzer.stop();
      finalize();
    });

    /***** ì €ì¥ (ìš©ëŸ‰ ìµœì í™”: ê³µë°± ì œê±° JSON) *****/
    saveButton.addEventListener('click', ()=>{
      if (!featureCollection.energy || featureCollection.energy.length===0){
        alert('ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'); return;
      }
      const payload = { bpm: bpmResult || null, features: featureCollection };
      const dataStr = JSON.stringify(payload); // ì••ì¶•í˜• JSON
      const blob = new Blob([dataStr], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = (originalFileName||'audio').replace(/\.[^/.]+$/,'') + '.json';
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
